<!DOCTYPE html>
<html>
<head>
    <title>Gestión de Productos</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body class="container mt-4">

<h2>Lista de Productos</h2>
<button class="btn btn-success mb-3" data-bs-toggle="modal" data-bs-target="#modalAgregar">+ Nuevo Producto</button>


<table id="tablaProductos" class="table table-bordered">
    <thead>
    <tr>
        <th>Codigo</th>
        <th>Nombre</th>
        <th>Precio Venta</th>
        <th>Stock</th>
        <th>Categoría</th>
        <th>Proveedor</th>
        <th>Acciones</th>
    </tr>
    </thead>
    <tbody></tbody>
</table>

<!-- Modal Agregar -->
<div class="modal fade" id="modalAgregar" tabindex="-1" aria-labelledby="modalAgregarLabel" aria-hidden="true">
    <div class="modal-dialog">
        <form id="formAgregar">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Nuevo Producto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="text" class="form-control mb-2" id="nombreAgregar" placeholder="Nombre" required>
                    <input type="text" class="form-control mb-2" id="descripcionAgregar" placeholder="Descripción">
                    <input type="number" class="form-control mb-2" id="precioCompraAgregar" placeholder="Precio Compra" required>
                    <input type="number" class="form-control mb-2" id="precioVentaAgregar" placeholder="Precio Venta" required>
                    <input type="number" class="form-control mb-2" id="stockAgregar" placeholder="Stock" required>
                    <select id="proveedorId" class="form-control mb-2"></select>
                    <select id="categoriaId" class="form-control mb-2"></select>

                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-success">Guardar</button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Modal Editar -->
<div class="modal fade" id="modalEditar" tabindex="-1" aria-labelledby="modalEditarLabel" aria-hidden="true">
    <div class="modal-dialog">
        <form id="formEditar">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Editar Producto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="idEditar">
                    <input type="text" class="form-control mb-2" id="nombreEditar" placeholder="Nombre" required>
                    <input type="text" class="form-control mb-2" id="descripcionEditar" placeholder="Descripción">
                    <input type="number" class="form-control mb-2" id="precioVentaEditar" placeholder="Precio Venta" required>
                    <input type="number" class="form-control mb-2" id="stockEditar" placeholder="Stock" required>
                    <input type="number" class="form-control mb-2" id="proveedorIdEditar" placeholder="Proveedor ID" required>
                    <input type="number" class="form-control mb-2" id="categoriaIdEditar" placeholder="Categoría ID" required>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Actualizar</button>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
    const apiUrl = 'http://localhost:2550/api/productos';

    // Cargar productos
    function cargarProductos() {
        fetch(apiUrl)
            .then(res => res.json())
            .then(data => {
                const tbody = document.querySelector("#tablaProductos tbody");
                tbody.innerHTML = '';
                data.forEach(producto => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${producto.codigo}</td>
                        <td>${producto.nombre}</td>
                        <td>${producto.precioVenta}</td>
                        <td>${producto.stock}</td>
                        <td>${producto.categoria.nombre}</td>
                        <td>${producto.proveedor.nombre}</td>
                        <td>
                            <button class="btn btn-primary btn-sm me-1" onclick='mostrarEditar(${JSON.stringify(producto)})'>Editar</button>
                            <button class="btn btn-danger btn-sm" onclick='eliminarProducto(${producto.id})'>Eliminar</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            });
    }

    // Agregar producto
    document.getElementById('formAgregar').addEventListener('submit', function(e) {
        e.preventDefault();
        const nuevoProducto = {
            nombre: document.getElementById('nombreAgregar').value,
            descripcion: document.getElementById('descripcionAgregar').value,
            precioCompra: parseFloat(document.getElementById('precioCompraAgregar').value), // puedes agregar campo si lo deseas
            precioVenta: parseFloat(document.getElementById('precioVentaAgregar').value),
            stock: parseInt(document.getElementById('stockAgregar').value),
            stockMinimo: 5,
            estado: true,
            proveedorId: parseInt(document.getElementById('proveedorIdAgregar').value),
            categoriaId: parseInt(document.getElementById('categoriaIdAgregar').value),
            codigo: "GEN" + Date.now() // ejemplo de código automático
        };
        fetch(apiUrl, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(nuevoProducto)
        })
        .then(() => {
            cargarProductos();
            document.getElementById('formAgregar').reset();
            const modalAgregar = bootstrap.Modal.getInstance(document.getElementById('modalAgregar'));
            modalAgregar.hide();
        });
    });

    // Mostrar datos en modal editar
    function mostrarEditar(producto) {
        document.getElementById('idEditar').value = producto.id;
        document.getElementById('nombreEditar').value = producto.nombre;
        document.getElementById('descripcionEditar').value = producto.descripcion;
        document.getElementById('precioVentaEditar').value = producto.precioVenta;
        document.getElementById('stockEditar').value = producto.stock;
        document.getElementById('proveedorIdEditar').value = producto.proveedor.id;
        document.getElementById('categoriaIdEditar').value = producto.categoria.id;
        const modalEditar = new bootstrap.Modal(document.getElementById('modalEditar'));
        modalEditar.show();
    }

    function cargarProveedoresYCategorias() {
    fetch('http://localhost:2550/api/proveedores')
        .then(res => res.json())
        .then(data => {
            const select = document.getElementById('proveedorId');
            select.innerHTML = data.map(p => `<option value="${p.id}">${p.nombre}</option>`).join('');
        });

    fetch('http://localhost:2550/api/categorias')
        .then(res => res.json())
        .then(data => {
            const select = document.getElementById('categoriaId');
            select.innerHTML = data.map(c => `<option value="${c.id}">${c.nombre}</option>`).join('');
        });
}


    // Editar producto
    document.getElementById('formEditar').addEventListener('submit', function(e) {
        e.preventDefault();
        const id = document.getElementById('idEditar').value;
        const productoEditado = {
            nombre: document.getElementById('nombreEditar').value,
            descripcion: document.getElementById('descripcionEditar').value,
            precioVenta: parseFloat(document.getElementById('precioVentaEditar').value),
            stock: parseInt(document.getElementById('stockEditar').value),
            proveedorId: parseInt(document.getElementById('proveedorIdEditar').value),
            categoriaId: parseInt(document.getElementById('categoriaIdEditar').value),
            estado: true,
            precioCompra: 0,
            stockMinimo: 5,
            codigo: "EDIT" + Date.now()
        };
        fetch(`${apiUrl}/${id}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(productoEditado)
        })
        .then(() => {
            cargarProductos();
            const modalEditar = bootstrap.Modal.getInstance(document.getElementById('modalEditar'));
            modalEditar.hide();
        });
    });

    // Eliminar producto
    function eliminarProducto(id) {
        if (confirm('¿Seguro que deseas eliminar este producto?')) {
            fetch(`${apiUrl}/${id}`, {
                method: 'DELETE'
            })
            .then(() => cargarProductos());
        }
    }

    // Inicial
    cargarProductos();
    cargarProveedoresYCategorias();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

